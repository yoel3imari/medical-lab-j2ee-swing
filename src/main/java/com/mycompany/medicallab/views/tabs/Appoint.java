/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package com.mycompany.medicallab.views.tabs;

import com.mycompany.medicallab.calendar.CalendarEvent;
import com.mycompany.medicallab.calendar.WeekCalendar;
import com.mycompany.medicallab.dao.AppointmentDao;
import com.mycompany.medicallab.models.Appointment;
import com.mycompany.medicallab.utils.JavaUtil;
import com.mycompany.medicallab.utils.NotificationUtil;
import com.mycompany.medicallab.views.forms.AppointmentForm;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import javax.swing.*;
import java.util.ArrayList;
import java.util.List;

/**
 *
 * @author yusef
 */
public class Appoint extends javax.swing.JPanel {

    AppointmentDao ado = new AppointmentDao();
    WeekCalendar cal;
    ArrayList<CalendarEvent> events = new ArrayList<>();
    List<Appointment> weekApt;

    /**
     * Creates new form Patients
     */
    public Appoint() {
        initComponents();
        
        mainAppointements.setLayout(new BoxLayout(mainAppointements, BoxLayout.Y_AXIS));
        mainAppointements.setSize(1080, 610);
        
        weekApt = new ArrayList<>();
        weekApt = ado.getAppointBetween(LocalDate.now(), JavaUtil.getNextSaturday(LocalDate.now()));
        
        createCalendar();

    }

    private void createCalendar() {

        cal = new WeekCalendar(events);
        cal.setSize(1080, 610);
        
        JButton goToTodayBtn = new JButton("Today");
        goToTodayBtn.addActionListener(e -> {
            weekApt = ado.getAppointBetween(LocalDate.now(), JavaUtil.getNextSaturday(LocalDate.now()));
            cal.goToToday();
            
        });
        JButton nextWeekBtn = new JButton(">");
        nextWeekBtn.addActionListener(e -> {
            cal.nextWeek();
            weekApt = ado.getAppointBetween(cal.getWeek().getDay(DayOfWeek.MONDAY), cal.getWeek().getDay(DayOfWeek.SATURDAY));
            displayEvents();
        });
        JButton nextMonthBtn = new JButton(">>");
        nextMonthBtn.addActionListener(e -> {
            cal.nextMonth();
            weekApt = ado.getAppointBetween(cal.getWeek().getDay(DayOfWeek.MONDAY), cal.getWeek().getDay(DayOfWeek.SATURDAY));
            displayEvents();
        });
        JButton lastApt = new JButton("Last");
        lastApt.addActionListener(e -> {
            cal.goToLast(ado.getLastAppointDate());
            weekApt = ado.getAppointBetween(cal.getWeek().getDay(DayOfWeek.MONDAY), cal.getWeek().getDay(DayOfWeek.SATURDAY));
            displayEvents();
        });
        
        weekControls.setLayout(new BoxLayout(weekControls, BoxLayout.X_AXIS));
        weekControls.add(goToTodayBtn);
        weekControls.add(nextWeekBtn);
        weekControls.add(nextMonthBtn);
        weekControls.add(lastApt);
        
        cal.addCalendarEmptyClickListener(e -> {
            LocalDateTime ldt = JavaUtil.regulateDateTime(e.getDateTime());
            if (ldt.isAfter(LocalDateTime.now())) {
                new AppointmentForm(cal, ldt);
            } else {
                new NotificationUtil("Selected Box Expired").show();
            }
        });
        cal.addCalendarEventClickListener(e -> {
            // get appoint
            new AppointmentForm(cal, e.getCalendarEvent());
        });
        
        displayEvents();
        
        mainAppointements.add(cal, BorderLayout.CENTER);
    }

    private void displayEvents() {
        weekApt.forEach(evt -> {
            cal.addEvent(new CalendarEvent(
                    evt,
                    evt.getDay(),
                    evt.getHour(),
                    evt.getHour().plusMinutes(JavaUtil.regulateDuration(evt.getTest().getDuration())),
                    evt.getTest().getLabel()
            ));
        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        weekControls = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        mainAppointements = new javax.swing.JPanel();

        setBackground(new java.awt.Color(254, 253, 237));
        setBorder(javax.swing.BorderFactory.createEmptyBorder(1, 20, 1, 20));
        setMaximumSize(new java.awt.Dimension(1080, 610));
        setMinimumSize(new java.awt.Dimension(1080, 610));
        setPreferredSize(new java.awt.Dimension(1080, 610));
        setLayout(new javax.swing.BoxLayout(this, javax.swing.BoxLayout.Y_AXIS));

        weekControls.setBackground(new java.awt.Color(254, 253, 237));
        weekControls.setCursor(new java.awt.Cursor(java.awt.Cursor.DEFAULT_CURSOR));
        weekControls.setMaximumSize(new java.awt.Dimension(32767, 40));
        weekControls.setMinimumSize(new java.awt.Dimension(0, 40));
        weekControls.setPreferredSize(new java.awt.Dimension(0, 40));
        weekControls.setLayout(new javax.swing.BoxLayout(weekControls, javax.swing.BoxLayout.X_AXIS));
        add(weekControls);

        jScrollPane1.setMaximumSize(new java.awt.Dimension(1040, 550));
        jScrollPane1.setMinimumSize(new java.awt.Dimension(1040, 550));
        jScrollPane1.setPreferredSize(new java.awt.Dimension(1040, 550));

        mainAppointements.setBackground(new java.awt.Color(254, 253, 237));
        mainAppointements.setMaximumSize(new java.awt.Dimension(1080, 610));
        mainAppointements.setMinimumSize(new java.awt.Dimension(1080, 610));
        mainAppointements.setPreferredSize(new java.awt.Dimension(1080, 610));
        mainAppointements.setLayout(new javax.swing.BoxLayout(mainAppointements, javax.swing.BoxLayout.LINE_AXIS));
        jScrollPane1.setViewportView(mainAppointements);

        add(jScrollPane1);
    }// </editor-fold>//GEN-END:initComponents


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JPanel mainAppointements;
    private javax.swing.JPanel weekControls;
    // End of variables declaration//GEN-END:variables
}
